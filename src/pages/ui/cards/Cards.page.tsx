import { ChangeEvent } from 'react'
import { useParams } from 'react-router-dom'

import { useSuperPagination } from '@/pages/hooks/useSuperPagination'
import { useSuperSearch } from '@/pages/ui/decks/hooks/useSuperSearch'
import {
  useDeleteCardMutation,
  useGetCardsQuery,
  useGetDeckByIdQuery,
  useUpdateCardMutation,
} from '@/services'
import {
  BackToDecks,
  CardsTable,
  ListHeader,
  Page,
  Pagination,
  SearchInput,
  Typography,
} from '@/shared'
import defDeckImg from '@/shared/assets/card-default-cover.webp'

import s from './Cards.page.module.scss'

export const CardsPage = () => {
  // ----- –î–æ—Å—Ç–∞–ª–∏ deck id –∏–∑ url-–∞ -----
  const params = useParams()
  const deckId = params.deckId ?? ''

  // ----- –•—É–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –∏ —Å url-–æ–º -----
  const {
    currentPage,
    handleCurrentPage,
    handlePerPage,
    itemsPerPage,
    optionsItemsPerPage,
    searchParams,
    setSearchParams,
  } = useSuperPagination([5, 10, 15])

  // ----- –•—É–∫ –∏ —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–∏—Å–∫–æ–º –ø–æ –≤–æ–ø—Ä–æ—Å—É -----
  const { search, searchInputOnChangeHandler, searchInputResetHandler } = useSuperSearch(
    searchParams,
    setSearchParams
  )
  const searchQuestionHandler = (e: ChangeEvent<HTMLInputElement>) => {
    searchInputOnChangeHandler(e.currentTarget.value)
  }

  // ----- –ó–∞–ø—Ä–æ—Å–∏–ª–∏ deck –ø–æ id —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å cover –∏ name -----
  const { data: deckByIdData } = useGetDeckByIdQuery({ id: deckId })

  // ----- –ó–∞–ø—Ä–æ—Å–∏–ª–∏ cards –∏—Å–ø–æ–ª—å–∑—É—è deck.id  -----
  const { data: cardsData, isLoading } = useGetCardsQuery(
    //{ id: deckId },
    {
      //authorId: 'qew',
      currentPage: +currentPage,
      id: deckId,
      itemsPerPage: +itemsPerPage,
      question: search,
      //name: search,
      //orderBy: tableSort,
    }
  )

  console.log(cardsData)

  // // ----- –•—É–∫ –∫–æ—Ç–æ—Ä—ã–π –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –∏ —Å url-–æ–º -----
  // const { searchParams, setSearchParams } = useSuperPagination([5, 10, 15])
  //
  // // ----- –•—É–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–∏—Å–∫–æ–º –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –≤–æ–ø—Ä–æ—Å–∞ -----
  // const { cardsQuestionSearch, data, search, searchTextResetHandler, setData } =
  //   useSuperCardsSearch(mockCardsData, searchParams, setSearchParams)

  // // ----- –•—É–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π -----
  // const { cardTableSort, sortOnClickHandler } = useSuperCardsSort(mockCardsData, setData)

  // ----- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ id –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã -----
  const userId = 6 === 6

  // ----- –ë–ª–æ–∫ —Ä–∞–±–æ—Ç—ã —Å –∑–∞–ø—Ä–æ—Å–æ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö -----
  //const [skip, setSkip] = useState(true)

  const [deleteCard] = useDeleteCardMutation()
  const [updateCard] = useUpdateCardMutation()
  // const [createCard] = useCreateCardMutation()

  // if (!skip) {
  //   console.log('Cards', data)
  // }

  const deleteCardHandler = (id: string) => {
    deleteCard({ id })
  }

  const updateCardHandler = (id: string) => {
    updateCard({ id })
  }

  // ----- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å Loader -----
  if (isLoading) {
    return <h1>Loading...</h1>
  }

  // const createCardHandler = (id: string) => {
  //   createCard({ answer: 'why&', id, question: 'because' })
  //   console.log('createCard')
  // }

  return (
    <Page mt={'24px'}>
      <BackToDecks iconId={'arrowBackOutline'} title={'Back to Decks List'} />
      <ListHeader
        buttonTitle={userId ? 'Add new card' : 'Learn to Pack'}
        title={deckByIdData?.name ?? 'Super Deck'}
        userId={userId}
      />
      <img alt={`Deck picture`} className={s.deckImg} src={deckByIdData?.cover ?? defDeckImg} />
      <SearchInput
        className={s.searchInput}
        onChange={searchQuestionHandler}
        placeholder={'Look for the question that you need'}
        searchTextResetHandler={searchInputResetHandler}
        value={search}
      />
      {cardsData?.items.length !== 0 ? (
        <>
          <CardsTable
            //cardTableSort={cardTableSort}
            cards={cardsData?.items}
            editFunction={updateCardHandler}
            //sortOnClick={sortOnClickHandler}
            trashFunction={deleteCardHandler}
            userId={userId}
          />
          <Pagination
            count={cardsData?.pagination.totalPages || 0}
            onChange={handleCurrentPage}
            onPerPageChange={handlePerPage}
            page={+currentPage}
            perPage={+itemsPerPage}
            perPageOptions={optionsItemsPerPage}
          />
        </>
      ) : (
        <Typography.H2 className={s.filterErrorPage}>
          No content with these terms...ü§¨
        </Typography.H2>
      )}
    </Page>
  )
}
